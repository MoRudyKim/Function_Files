---
title: "Power Prices and Volatiliies"
output: html_notebook
---

This notebook is a prototype for viewing power prices and computing and plotting power price volatilities.

This version is a first prototype and will be used for testing purposes.

# Data Import and Manipulation

## Data Import

 The first step is to import the latest price data and append them to the power curve 
repository (created in RDS format). If the curve date falls on a Saturday or a Sunday, this process will not run.

```{r echo=FALSE, results='hide', warning=FALSE, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(tidyquant)
library(gridExtra)

setwd("P:/R_Dev/Price_Related")

if(wday(Sys.Date() -1 %in% c(1,7))) {
  stop("Date you entered is a weekend date. Please manually adjust the curve date.")
} else {
  date <- format(as.Date(Sys.Date() - 1), "%m%d%Y")
}
  
path <- "\\\\porfiler02\\RMShared\\Power Curves\\"
dt <- read_csv(paste0(path,"PowerCurves_",date,".csv"))
dt <- dt %>%
  dplyr::filter(!`TIME INDEX` == 0)

dtm <- readRDS("PowerCurves.rds")
dtm <- as.data.frame(dtm)
dt <- as.data.frame(dt)

names(dt) <- c("Sys_Date", "Stamp_Date", "Time_Index",
               "POD", "Tenor", "Peak","Offpeak")

data_convert <- function(x) {
  date_con <- as.Date(x, format = "%d-%b-%y")
  date_con
}

dt <- dt %>%
  mutate_at(vars(Sys_Date, Stamp_Date, Tenor), data_convert)

dt <- dt %>%
  mutate(Qtr = quarter(Tenor, with_year = TRUE),
         Wday = wday(Stamp_Date))

dt <- dt %>%
  mutate_at(vars(Time_Index,Wday), as.integer)

dt <- rbind(dtm, dt)
saveRDS(dt,"PowerCurves.rds")
rm(dtm)

dt <- dt%>%
  group_by(Qtr, POD, Stamp_Date) %>%
  mutate(aPeak = mean(Peak, na.rm = TRUE),
         aOffPeak = mean(Offpeak, na.rm = TRUE))
```

## Function Load

Functions were created to manipulate master price data set. Much of the functions will query the data based on time and trade location; calculate price return data; and, compute volatility.

```{r echo=FALSE, results='hide', warning=FALSE, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)

path <- "P:/R_Dev/Price_Related/Function_Files/"
source(paste0(path,"plotFunctions.R"))
source(paste0(path,"grpDataPrepFunctions.R"))

```

## Price Curve Data Preop

### Load and prepare data for 2019 Q3 strip (peak and off-peak) for PJM West Hub

```{r echo=FALSE, results='hide', warning=FALSE, include=FALSE, message=FALSE}

qtr <- 2019.3
hub <- "WEST_H"
mn <- "2019-05-01"

qprcdata <- quarterlyPriceData(dt, qtr, hub)
qpeakret <- qt_peakReturnData(qprcdata)
qopret <- qt_offpeakReturnData(qprcdata)
qpeakvol <- qt_peakVolData(qpeakret, 30, 252)
qoffpeakvol <- qt_offpeakVolData(qopret, 30, 252)

```




